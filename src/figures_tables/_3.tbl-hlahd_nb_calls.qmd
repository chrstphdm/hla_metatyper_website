---
title: ""
execute:
  echo: false
jupyter: python3
output: word_document
cap-location: bottom
format: 
  html:
    page-layout: full
  pdf:
    pdf-engine: lualatex
    fontsize: 12pt
    mainfont: Open Sans
    sansfont: Open Sans
    # classoption: landscape
    pagestyle: empty
    include-in-header: 
      text: |
        \usepackage{lscape}
        \newcommand{\blandscape}{\begin{landscape}}
        \newcommand{\elandscape}{\end{landscape}}
  
---


```{python}
#| label: tbl-hlahd_nb_calls
#| tbl-cap: This table describe the number of calls obtained from HLA-HD regarding the quality of alleles. Threshold usually used by the community are the sum of the number of reads for allele 1 & 2 (minimum of 20) and individual number of reads for allele 1 or 2 (minimum of 10). 
#| 
import pandas
import numpy as np
from IPython.display import Markdown, display
def printmd(string):
    display(Markdown(string))

def tbl_hlahd_nb_calls():
  rez_filtered_hlahd = pandas.read_csv('data/OUTPUT/5.N_1_RESULTS/all_results-filtered.csv')
  genes_list = sorted(rez_filtered_hlahd.gene.unique().tolist())
  markdown_text="| Gene | total calls | calls < threshold | calls < threshold (%) |\n"
  markdown_text+="| --- | --- | --- | --- |\n"

  for n,gene in enumerate(genes_list ):
    # if gene in ["DRB2","DRB3","DRB4","DRB5"]:
    #   continue
    hlahd_results_filtered = rez_filtered_hlahd.query("gene == @gene")
    hlahd_results_filtered = hlahd_results_filtered.loc[~hlahd_results_filtered['hlahd_genotype'].isna()]

    ## nb available calls
    nb_calls_all_hlahd_results = hlahd_results_filtered.shape[0]
    ## only calls < threshold_1
    filtered_bad_results_hlahd = hlahd_results_filtered.loc[((hlahd_results_filtered['filter_int'] & (1 << 1) == (1 << 1)))].shape[0]
    ## percentage calls < threshold_1
    percentage_calls_bad_hlahd_results = filtered_bad_results_hlahd/nb_calls_all_hlahd_results*100 if nb_calls_all_hlahd_results > 0 else 0
    
    markdown_text+=f"|{gene}|{nb_calls_all_hlahd_results}|{filtered_bad_results_hlahd}|{percentage_calls_bad_hlahd_results:.2f}|\n"
    
  printmd(markdown_text)
  # display(df_hlahd)
tbl_hlahd_nb_calls()
```