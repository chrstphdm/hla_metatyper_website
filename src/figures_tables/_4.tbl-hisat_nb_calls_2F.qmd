---
title: ""
execute:
  echo: false
jupyter: python3
output: word_document
cap-location: bottom
format: 
  html:
    page-layout: full
  pdf:
    pdf-engine: lualatex
    fontsize: 12pt
    mainfont: Open Sans
    sansfont: Open Sans
    # classoption: landscape
    pagestyle: empty
    include-in-header: 
      text: |
        \usepackage{lscape}
        \newcommand{\blandscape}{\begin{landscape}}
        \newcommand{\elandscape}{\end{landscape}}
  
---


```{python}
#| label: tbl-hisat_nb_calls_2F
#| tbl-cap: This table describe the number of calls obtained from HISATgenotype (**DOWNSCALED to 2 fields**)  regarding the quality of alleles only. Considering the average size of an exon (150bp) and an intron (1 - 50KB) in the human genome, we will use the value of 200 reads as a threshold. 
#| 
import pandas
import numpy as np
from IPython.display import Markdown, display
def printmd(string):
    display(Markdown(string))

def tbl_hisat_nb_calls_2F():
  rez_filtered_hisat = pandas.read_csv('data/OUTPUT/5.N_1_RESULTS/all_results-2F-filtered.csv')

  genes_list = sorted(rez_filtered_hisat.gene.unique().tolist())
  markdown_text="| Gene | total calls | calls < threshold | calls < threshold (%) |\n"
  markdown_text+="| --- | --- | --- | --- |\n"

  for n,gene in enumerate(genes_list ):
    # if gene in ["DRB2","DRB3","DRB4","DRB5"]:
    #   continue
    hisat_results_filtered = rez_filtered_hisat.query("gene == @gene")
    hisat_results_filtered = hisat_results_filtered.loc[~hisat_results_filtered['hisat_genotype'].isna()]

    ## nb available calls
    nb_calls_all_hisat_results = hisat_results_filtered.shape[0]
    ## only calls < threshold_1
    filtered_bad_results_hisat = hisat_results_filtered.loc[((hisat_results_filtered['filter_int'] & (1 << 0) == (1 << 0)))].shape[0]

    ## percentage calls < threshold_1
    percentage_calls_bad_hisat_results = filtered_bad_results_hisat/nb_calls_all_hisat_results*100 if nb_calls_all_hisat_results > 0 else 0
    
    markdown_text+=f"|{gene}|{nb_calls_all_hisat_results}|{filtered_bad_results_hisat}|{percentage_calls_bad_hisat_results:.2f}|\n"

  printmd(markdown_text)
  # display(df_hisat)
tbl_hisat_nb_calls_2F()
```